from __init__ import setup_project_paths
setup_project_paths()

import streamlit as st
import matplotlib.pyplot as plt

from core.data.manager import DataManager

if 'page_initialized' not in st.session_state:
    st.session_state.page_initialized = True
    st.set_page_config(
        layout="wide",
        initial_sidebar_state="expanded",
        page_title="Processed EEG Data",
        page_icon="üìä"
    )

st.title("üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")


manager = DataManager()

st.sidebar.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
amplitude_scale = st.sidebar.slider("–ú–∞—Å—à—Ç–∞–± –∞–º–ø–ª–∏—Ç—É–¥—ã", min_value=0.5, max_value=10000.0, value=10.0, step=0.000001, format="%.1f")
vertical_spacing = st.sidebar.slider("–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏", min_value=0.5, max_value=1000.0, value=10.0, step=0.00001, format="%.1f")
channels_to_show = st.sidebar.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤", min_value=1, max_value=64, value=32, step=1)
time_samples = st.sidebar.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Å—á—ë—Ç–æ–≤", min_value=100, max_value=50000, value=5000, step=100)

processed_data = manager.list_all_processed()

if not processed_data:
    st.info("üì• –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 'Pipeline' –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤.")
else:
    from collections import defaultdict
    grouped_data = defaultdict(list)
    for item in processed_data:
        grouped_data[item['parent_id']].append(item)
    
    source_files = {}
    for parent_id in grouped_data.keys():
        source_info = manager.get_sample_info(parent_id)
        if source_info:
            source_files[parent_id] = source_info
    
    for parent_id, processed_list in grouped_data.items():
        source_info = source_files.get(parent_id, {})
        source_name = source_info.get('filename', f'Unknown ({parent_id[:8]})')
        
        with st.expander(f"üìÅ {source_name} ({len(processed_list)} –æ–±—Ä–∞–±–æ—Ç–æ–∫)", expanded=False):
            if source_info:
                st.markdown(f"""
                **–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª:** `{source_name}`  
                **–ß–∞—Å—Ç–æ—Ç–∞:** {source_info.get('sfreq', 'N/A')} Hz  
                **–ö–∞–Ω–∞–ª–æ–≤:** {source_info.get('n_channels', 'N/A')}  
                **–û—Ç—Å—á—ë—Ç–æ–≤:** {source_info.get('n_samples', 'N/A'):,}
                """)
            
            st.divider()
            
            for item in processed_list:
                proc_id = item['id']
                short_id = proc_id[:8]
                
                card_class = "data-card"
                if 'selected_processed_id' in st.session_state and st.session_state.selected_processed_id == proc_id:
                    card_class += " highlight-card"
                
                
                created_at = item.get('created_at_formatted', item.get('created_at', ''))
                st.markdown(f"**–û–±—Ä–∞–±–æ—Ç–∫–∞ ID:** `{short_id}` ‚Ä¢ **–°–æ–∑–¥–∞–Ω–æ:** {created_at}")
                
                st.markdown(f"""
                **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** {item.get('sfreq', 'N/A')} Hz ‚Ä¢ 
                {item.get('n_channels', 'N/A')} –∫–∞–Ω–∞–ª–æ–≤ ‚Ä¢ 
                {item.get('n_samples', 'N/A'):,} –æ—Ç—Å—á—ë—Ç–æ–≤
                """)
                
                proc_info = manager.get_processed_info(proc_id)
                if proc_info and proc_info.get('pipeline_config'):
                    pipeline_cfg = proc_info['pipeline_config']
                    steps = pipeline_cfg.get('steps', [])
                    if steps:
                        st.markdown("**–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏:**")
                        with st.expander("üìã –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏", expanded=False):
                            for i, step in enumerate(steps, 1):
                                step_name = step.get('name', 'Unknown')
                                step_params = step.get('params', {})
                                st.markdown(f"{i}. **{step_name}**: {step_params}")
                
                btn_col1, btn_col2, btn_col3 = st.columns([1, 1, 2])
                
                with btn_col1:
                    if st.button("üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä", key=f"view_{proc_id}", use_container_width=True):
                        st.session_state.selected_processed_id = proc_id
                        st.rerun()
                
                with btn_col2:
                    if st.button("üóë –£–¥–∞–ª–∏—Ç—å", key=f"delete_{proc_id}", use_container_width=True):
                        if manager.delete_processed_sample(proc_id):
                            if 'selected_processed_id' in st.session_state and st.session_state.selected_processed_id == proc_id:
                                del st.session_state.selected_processed_id
                            st.success(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ {short_id} —É–¥–∞–ª–µ–Ω–∞")
                            st.rerun()
                        else:
                            st.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {short_id}")
                
                if 'selected_processed_id' in st.session_state and st.session_state.selected_processed_id == proc_id:
                    st.divider()
                    st.subheader(f"üëÅ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ {short_id}")
                    
                    try:
                        proc_sample = manager.get_processed_sample(proc_id)
                        if proc_sample is not None and proc_sample.data is not None:
                            data_shape = proc_sample.data.shape
                            n_channels = data_shape[0]
                            n_samples = data_shape[1] if len(data_shape) == 2 else data_shape[2]
                            
                            viz_col1, viz_col2, viz_col3 = st.columns(3)
                            with viz_col1:
                                st.metric("–ö–∞–Ω–∞–ª–æ–≤", n_channels)
                            with viz_col2:
                                st.metric("–û—Ç—Å—á—ë—Ç–æ–≤", f"{n_samples:,}")
                            with viz_col3:
                                st.metric("–ß–∞—Å—Ç–æ—Ç–∞", f"{proc_sample.sfreq} Hz")
                            
                            fig, ax = plt.subplots(figsize=(12, 6))
                            
                            display_channels = min(channels_to_show, n_channels)
                            display_samples = min(time_samples, n_samples)
                            
                            if len(data_shape) == 3:
                                data_to_plot = proc_sample.data[:, 0, :]
                            else:
                                data_to_plot = proc_sample.data
                            
                            for i in range(display_channels):
                                channel_data = data_to_plot[i][:display_samples] * amplitude_scale
                                ax.plot(channel_data + i * vertical_spacing, 
                                       linewidth=0.8, alpha=0.8)
                            
                            ax.set_xlabel('–í—Ä–µ–º—è (–æ—Ç—Å—á—ë—Ç—ã)')
                            ax.set_ylabel('–ê–º–ø–ª–∏—Ç—É–¥–∞')
                            ax.set_title(f'–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (ID: {short_id})')
                            ax.grid(True, alpha=0.3)
                            
                            st.pyplot(fig)
                            
                            if st.button("‚ùå –ó–∞–∫—Ä—ã—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é", key=f"close_viz_{proc_id}"):
                                del st.session_state.selected_processed_id
                                st.rerun()
                        else:
                            st.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏")
                    except Exception as e:
                        st.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: {str(e)}")
                
                st.divider()